<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bug Reproduction Engine</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background-color: #0f0f0f;
            color: #e0e0e0;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .header {
            background-color: #1a1a1a;
            padding: 1rem;
            text-align: center;
            border-bottom: 1px solid #333;
        }

        .header h1 {
            font-size: 1.5rem;
            color: #4a9eff;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .status-indicator {
            width: 10px;
            height: 10px;
            background-color: #00ff00;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }        .container {
            flex: 1;
            display: flex;
            flex-direction: column;
            max-width: 1000px;
            margin: 0 auto;
            width: 100%;
            padding: 1rem;
            gap: 1rem;
            height: calc(100vh - 80px); /* Subtract header height */
            overflow: hidden;
        }        .chat-container {
            flex: 1;
            background-color: #1a1a1a;
            border-radius: 10px;
            padding: 1rem;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 1rem;
            min-height: 0; /* Allow flex shrinking */
        }.message {
            display: flex;
            gap: 0.5rem;
            animation: fadeIn 0.3s ease-in;
            margin-bottom: 0.5rem;
            width: 100%;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Custom Scrollbar Styling */
        ::-webkit-scrollbar {
            width: 12px;
            height: 12px;
        }

        ::-webkit-scrollbar-track {
            background: #0f0f0f;
            border-radius: 10px;
            border: 1px solid #333;
        }

        ::-webkit-scrollbar-thumb {
            background: linear-gradient(180deg, #4a9eff 0%, #357abd 100%);
            border-radius: 10px;
            border: 1px solid #2a2a2a;
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.3);
        }

        ::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(180deg, #5ba7ff 0%, #4085d1 100%);
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.5);
        }

        ::-webkit-scrollbar-thumb:active {
            background: linear-gradient(180deg, #357abd 0%, #2a5f8f 100%);
        }

        ::-webkit-scrollbar-corner {
            background: #0f0f0f;
        }

        /* Firefox Scrollbar Styling */
        * {
            scrollbar-width: thin;
            scrollbar-color: #4a9eff #0f0f0f;
        }

        /* Chat container specific scrollbar */
        .chat-container::-webkit-scrollbar-thumb {
            background: linear-gradient(180deg, #4a9eff 0%, #357abd 100%);
            border: 2px solid #1a1a1a;
            border-radius: 10px;
        }

        .chat-container::-webkit-scrollbar-track {
            background: #1a1a1a;
            border-radius: 10px;
        }

        .message.user {
            justify-content: flex-end;
        }

        .message.bot {
            justify-content: flex-start;
        }

        .message-content {
            max-width: 70%;
            padding: 0.75rem 1rem;
            border-radius: 15px;
            word-wrap: break-word;
            white-space: pre-wrap;
            line-height: 1.5;
            position: relative;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
        }        .message.user .message-content {
            background-color: #4a9eff;
            color: white;
            border-bottom-right-radius: 4px;
            position: relative;
        }

        .message.assistant .message-content {
            background-color: #2a2a2a;
            color: #e0e0e0;
            border-bottom-left-radius: 4px;
            position: relative;
        }        .message-time {
            font-size: 0.75rem;
            color: #666;
            margin-top: 0.25rem;
            text-align: right;
        }

        .message.user .message-time {
            text-align: right;
        }

        .message.assistant .message-time {
            text-align: left;
        }        /* Fix for bug information display width */
        .message.assistant:has(.bug-info-display) .message-content {
            max-width: 85%;
        }
        
        /* Fallback for browsers that don't support :has() */
        .message.assistant.bug-message .message-content {
            max-width: 85%;
        }

        .file-attachment {
            background-color: #1e1e1e;
            border: 1px solid #333;
            border-radius: 8px;
            padding: 0.75rem;
            margin-top: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .file-icon {
            width: 40px;
            height: 40px;
            background-color: #4a9eff;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.2rem;
        }

        .file-info {
            flex: 1;
        }

        .file-name {
            font-weight: 500;
            color: #e0e0e0;
        }

        .file-size {
            font-size: 0.75rem;
            color: #666;
        }

        .analyze-button {
            padding: 0.5rem 1rem;
            background-color: #4a9eff;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.875rem;
            transition: background-color 0.3s;
        }

        .analyze-button:hover {
            background-color: #357abd;
        }

        .analyze-button:disabled {
            background-color: #333;
            cursor: not-allowed;
        }

        .file-upload-area {
            background-color: #1a1a1a;
            border: 2px dashed #333;
            border-radius: 10px;
            padding: 2rem;
            text-align: center;
            margin-bottom: 1rem;
            transition: all 0.3s;
            display: none;
        }

        .file-upload-area.show {
            display: block;
        }

        .file-upload-area.drag-over {
            border-color: #4a9eff;
            background-color: #1e1e1e;
        }

        .upload-icon {
            font-size: 3rem;
            color: #4a9eff;
            margin-bottom: 1rem;
        }

        .upload-text {
            color: #999;
            margin-bottom: 1rem;
        }

        .browse-button {
            padding: 0.5rem 1.5rem;
            background-color: #2a2a2a;
            color: #e0e0e0;
            border: 1px solid #333;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .browse-button:hover {
            background-color: #333;
            border-color: #4a9eff;
        }        .input-wrapper {
            flex: 1;
            position: relative;
        }

        #messageInput {
            width: 100%;
            padding: 0.75rem;
            background-color: #2a2a2a;
            border: 1px solid #333;
            border-radius: 25px;
            color: #e0e0e0;
            font-size: 1rem;
            outline: none;
            transition: border-color 0.3s;
        }

        #messageInput:focus {
            border-color: #4a9eff;
        }

        .attach-button {
            padding: 0.75rem;
            background-color: #2a2a2a;
            color: #e0e0e0;
            border: 1px solid #333;
            border-radius: 50%;
            cursor: pointer;
            width: 45px;
            height: 45px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }

        .attach-button:hover {
            background-color: #333;
            border-color: #4a9eff;
        }

        button {
            padding: 0.75rem 1.5rem;
            background-color: #4a9eff;
            color: white;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1rem;
            transition: background-color 0.3s;
        }

        button:hover {
            background-color: #357abd;
        }

        button:disabled {
            background-color: #333;
            cursor: not-allowed;
        }        .controls {
            display: flex;
            gap: 0.5rem;
            justify-content: center;
            flex-wrap: wrap;
            flex-shrink: 0; /* Prevent shrinking */
        }

        .input-container {
            display: flex;
            gap: 0.5rem;
            padding: 1rem;
            background-color: #1a1a1a;
            border-radius: 10px;
            align-items: center;
            flex-shrink: 0; /* Prevent shrinking */
        }

        .bottom-section {
            flex-shrink: 0; /* Prevent the bottom section from shrinking */
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .control-btn {
            padding: 0.5rem 1rem;
            background-color: #2a2a2a;
            font-size: 0.875rem;
        }

        .settings-panel {
            position: fixed;
            right: -300px;
            top: 0;
            width: 300px;
            height: 100vh;
            background-color: #1a1a1a;
            padding: 2rem 1rem;
            transition: right 0.3s;
            z-index: 1000;
            overflow-y: auto;
        }

        .settings-panel.open {
            right: 0;
        }

        .settings-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }

        .setting-item {
            margin-bottom: 1.5rem;
        }

        .setting-item label {
            display: block;
            margin-bottom: 0.5rem;
            font-size: 0.875rem;
            color: #999;
        }

        .setting-item input[type="range"] {
            width: 100%;
            margin-bottom: 0.5rem;
        }

        .setting-value {
            text-align: center;
            color: #4a9eff;
            font-size: 0.875rem;
        }        .bug-lookup-container {
            background-color: #1a1a1a;
            border-radius: 10px;
            padding: 1rem;
            margin-bottom: 1rem;
            display: none;
        }

        .bug-lookup-container.show {
            display: block;
        }

        .bug-lookup-header {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 1rem;
            color: #4a9eff;
            font-weight: 600;
        }

        .bug-lookup-input-container {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }

        #bugIdInput {
            flex: 1;
            padding: 0.75rem;
            background-color: #2a2a2a;
            border: 1px solid #333;
            border-radius: 8px;
            color: #e0e0e0;
            font-size: 1rem;
            outline: none;
            transition: border-color 0.3s;
        }

        #bugIdInput:focus {
            border-color: #4a9eff;
        }

        #bugIdInput::placeholder {
            color: #666;
        }

        .lookup-button {
            padding: 0.75rem 1.5rem;
            background-color: #4a9eff;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            transition: background-color 0.3s;
            white-space: nowrap;
        }

        .lookup-button:hover {
            background-color: #357abd;
        }

        .lookup-button:disabled {
            background-color: #333;
            cursor: not-allowed;
        }        .bug-info-display {
            background-color: #1e2936;
            border: 1px solid #2a4158;
            border-radius: 8px;
            padding: 1rem;
            margin-top: 0.5rem;
        }.bug-info-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1rem;
            gap: 1rem;
        }

        .bug-title {
            font-weight: 600;
            color: #4a9eff;
            font-size: 1.1rem;
            margin-bottom: 0.25rem;
        }

        .bug-id {
            font-size: 0.875rem;
            color: #666;
        }

        .bug-status {
            padding: 0.25rem 0.75rem;
            border-radius: 15px;
            font-size: 0.75rem;
            font-weight: 500;
            text-transform: uppercase;
        }

        .bug-status.new {
            background-color: #1e3a3a;
            color: #4ade80;
        }

        .bug-status.in-progress {
            background-color: #3a2e1e;
            color: #fbbf24;
        }

        .bug-status.resolved {
            background-color: #1e2e3a;
            color: #60a5fa;
        }

        .bug-status.closed {
            background-color: #2a1e2a;
            color: #a78bfa;
        }        .bug-meta {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 0.75rem;
            margin-bottom: 1rem;
            padding: 0.75rem;
            background-color: #1a1a1a;
            border-radius: 6px;
        }

        .bug-meta-item {
            display: flex;
            flex-direction: column;
        }

        .bug-meta-label {
            font-size: 0.75rem;
            color: #666;
            margin-bottom: 0.25rem;
            text-transform: uppercase;
            font-weight: 500;
        }

        .bug-meta-value {
            color: #e0e0e0;
            font-size: 0.875rem;
        }        .bug-description {
            background-color: #1a1a1a;
            padding: 0.75rem;
            border-radius: 6px;
            color: #e0e0e0;
            line-height: 1.6;
            margin-bottom: 1rem;
            max-height: none;
            overflow: visible;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }

        .bug-description p {
            margin: 0 0 0.75rem 0;
        }

        .bug-description p:last-child {
            margin-bottom: 0;
        }

        .bug-description strong {
            color: #4a9eff;
            font-weight: 600;
        }

        .bug-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }        .bug-tag {
            padding: 0.25rem 0.5rem;
            background-color: #2a2a2a;
            color: #4a9eff;
            border-radius: 12px;
            font-size: 0.75rem;
            border: 1px solid #333;
        }

        .bug-action-buttons {
            display: flex;
            gap: 0.75rem;
            margin-top: 1rem;
            flex-wrap: wrap;
        }

        .bug-action-btn {
            padding: 0.6rem 1.2rem;
            background-color: #2a2a2a;
            color: #e0e0e0;
            border: 1px solid #333;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.875rem;
            font-weight: 500;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            white-space: nowrap;
        }

        .bug-action-btn:hover {
            background-color: #333;
            border-color: #4a9eff;
            color: #4a9eff;
            transform: translateY(-1px);
        }

        .bug-action-btn:active {
            transform: translateY(0);
        }

        .bug-action-btn.guide-me {
            border-color: #22c55e;
        }

        .bug-action-btn.guide-me:hover {
            background-color: #166534;
            border-color: #22c55e;
            color: #22c55e;
        }

        .bug-action-btn.analyze-log {
            border-color: #f59e0b;
        }

        .bug-action-btn.analyze-log:hover {
            background-color: #78350f;
            border-color: #f59e0b;
            color: #f59e0b;
        }

        .bug-action-btn.repro-scenario {
            border-color: #8b5cf6;
        }

        .bug-action-btn.repro-scenario:hover {
            background-color: #5b21b6;
            border-color: #8b5cf6;
            color: #8b5cf6;
        }

        .loading {
            display: none;
            align-items: center;
            gap: 0.5rem;
            color: #666;
            font-size: 0.875rem;
            padding: 0.5rem 0;
        }

        .loading.show {
            display: flex;
        }

        .loading-dots {
            display: flex;
            gap: 0.25rem;
        }

        .loading-dots span {
            width: 8px;
            height: 8px;
            background-color: #4a9eff;
            border-radius: 50%;
            animation: loadingDot 1.4s infinite ease-in-out both;
        }

        .loading-dots span:nth-child(1) { animation-delay: -0.32s; }
        .loading-dots span:nth-child(2) { animation-delay: -0.16s; }

        @keyframes loadingDot {
            0%, 80%, 100% {
                transform: scale(0);
                opacity: 0.5;
            }
            40% {
                transform: scale(1);
                opacity: 1;
            }
        }

        .close-btn {
            background: none;
            color: #999;
            font-size: 1.5rem;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }

        .analysis-result {
            background-color: #1e2936;
            border: 1px solid #2a4158;
            border-radius: 8px;
            padding: 1rem;
            margin-top: 0.5rem;
        }

        .analysis-header {
            font-weight: 600;
            color: #4a9eff;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .analysis-content {
            color: #e0e0e0;
            line-height: 1.6;
        }        @media (max-width: 768px) {
            .message-content {
                max-width: 85%;
            }
            
            .message.assistant:has(.bug-info-display) .message-content,
            .message.assistant.bug-message .message-content {
                max-width: 92%;
            }
            
            .bug-meta {
                grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
                gap: 0.5rem;
                padding: 0.5rem;
            }
            
            .bug-info-header {
                flex-direction: column;
                gap: 0.75rem;
                align-items: flex-start;
            }
            
            .controls {
                font-size: 0.75rem;
            }
            
            .control-btn {
                padding: 0.4rem 0.8rem;
            }

            .bug-action-buttons {
                gap: 0.5rem;
            }

            .bug-action-btn {
                padding: 0.5rem 1rem;
                font-size: 0.8rem;
                gap: 0.4rem;
            }
        }
    </style>
</head>
<body>
    <div class="header">        <h1>
            <span class="status-indicator"></span>
            Bug Reproduction Engine
        </h1>
    </div>

    <div class="container">
        <div class="file-upload-area" id="fileUploadArea" ondrop="handleDrop(event)" ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)">
            <div class="upload-icon">📎</div>
            <div class="upload-text">Drag and drop log files here or</div>
            <button class="browse-button" onclick="document.getElementById('fileInput').click()">Browse Files</button>
            <input type="file" id="fileInput" style="display: none;" accept=".txt,.log,.dmp,.dump,.err,.out,.crash,.trace" onchange="handleFileSelect(event)">
        </div>

        <div class="bug-lookup-container" id="bugLookupContainer">
            <div class="bug-lookup-header">
                🐛 Bug Lookup
            </div>
            <div class="bug-lookup-input-container">
                <input 
                    type="text" 
                    id="bugIdInput" 
                    placeholder="Enter Bug ID (e.g., BUG-DEMO-1748084066155-0)"
                    onkeypress="handleBugLookupKeyPress(event)"
                >
                <button class="lookup-button" onclick="lookupBug()" id="lookupButton">
                    Lookup
                </button>
            </div>
        </div>

        <div class="chat-container" id="chatContainer">
            <div class="message assistant">
                <div class="message-content">Hello! I'm your Phi-3 assistant. I can help you analyze error logs and crash dumps. You can drag and drop log files or click the attachment button to upload them.</div>
                <div class="message-time">Just now</div>
            </div>
        </div>

        <div class="loading" id="loadingIndicator">
            <span>Phi-3 is thinking</span>
            <div class="loading-dots">
                <span></span>
                <span></span>
                <span></span>
            </div>        </div>

        <div class="bottom-section">
            <div class="controls">
                <button class="control-btn" onclick="clearChat()">Clear Chat</button>
                <button class="control-btn" onclick="toggleBugLookup()">Bug Lookup</button>
                <button class="control-btn" onclick="toggleSettings()">Settings</button>
                <button class="control-btn" onclick="downloadHistory()">Download History</button>
            </div>

            <div class="input-container">
                <button class="attach-button" onclick="toggleFileUpload()" title="Attach log file">
                    📎
                </button>
                <div class="input-wrapper">
                    <input 
                        type="text" 
                        id="messageInput" 
                        placeholder="Type your message here..."
                        onkeypress="handleKeyPress(event)"
                        autocomplete="off"
                    >
                </div>
                <button onclick="sendMessage()" id="sendButton">Send</button>
            </div>
        </div>
    </div>

    <div class="settings-panel" id="settingsPanel">
        <div class="settings-header">
            <h2>Settings</h2>
            <button class="close-btn" onclick="toggleSettings()">×</button>
        </div>
        
        <div class="setting-item">
            <label for="temperatureSlider">Temperature (Creativity)</label>
            <input 
                type="range" 
                id="temperatureSlider" 
                min="0.1" 
                max="1.0" 
                step="0.1" 
                value="0.3"
                oninput="updateTemperature(this.value)"
            >
            <div class="setting-value" id="temperatureValue">0.3</div>
        </div>
        
        <div class="setting-item">
            <label for="maxTokensSlider">Max Response Length</label>
            <input 
                type="range" 
                id="maxTokensSlider" 
                min="50" 
                max="600" 
                step="50" 
                value="400"
                oninput="updateMaxTokens(this.value)"
            >
            <div class="setting-value" id="maxTokensValue">400 tokens</div>
        </div>
        
        <div class="setting-item">
            <label>Model Info</label>
            <div style="color: #666; font-size: 0.875rem;">
                <p>Model: Phi-3-mini-4k-instruct</p>
                <p id="deviceInfo">Device: Loading...</p>
            </div>
        </div>
    </div>

    <script>        let isProcessing = false;
        let uploadedFiles = [];
        let currentBugData = null;        // BTS Configuration
        const BTS_API_URL = '/bts';

        // Bug Lookup Functions
        function toggleBugLookup() {
            const container = document.getElementById('bugLookupContainer');
            container.classList.toggle('show');
            if (container.classList.contains('show')) {
                document.getElementById('bugIdInput').focus();
            }
        }

        function handleBugLookupKeyPress(event) {
            if (event.key === 'Enter') {
                event.preventDefault();
                lookupBug();
            }
        }

        async function lookupBug() {
            const input = document.getElementById('bugIdInput');
            const bugId = input.value.trim();
            
            if (!bugId) {
                addMessage('Please enter a bug ID.', 'assistant');
                return;
            }
            
            const lookupButton = document.getElementById('lookupButton');
            lookupButton.disabled = true;
            lookupButton.textContent = 'Looking up...';
            
            try {
                // First try to get all bugs and find the specific one
                const response = await fetch(`${BTS_API_URL}/bugs`);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const bugs = await response.json();
                const bug = bugs.find(b => b.id === bugId);
                
                if (bug) {
                    currentBugData = bug;
                    displayBugInfo(bug);
                    addBugToChat(bug);
                } else {
                    addMessage(`Bug with ID "${bugId}" not found. Please check the ID and try again.`, 'assistant');
                }
            } catch (error) {
                console.error('Error fetching bug:', error);
                addMessage(`Error looking up bug: ${error.message}. Make sure the BTS backend is running on port 3001.`, 'assistant');
            } finally {
                lookupButton.disabled = false;
                lookupButton.textContent = 'Lookup';
                input.value = '';
            }
        }

        function displayBugInfo(bug) {
            // This function could be used to show bug info in a dedicated panel if needed
            console.log('Bug data:', bug);
        }        function addBugToChat(bug) {
            const chatContainer = document.getElementById('chatContainer');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message assistant bug-message';
            
            const time = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
              const tagsHtml = bug.tags && bug.tags.length > 0 
                ? `<div class="bug-tags">${bug.tags.map(tag => `<span class="bug-tag">${escapeHtml(tag)}</span>`).join('')}</div>`
                : '';

            const actionButtonsHtml = `
                <div class="bug-action-buttons">
                    <button class="bug-action-btn guide-me" onclick="guideMeAction('${escapeHtml(bug.id)}')">
                        <span>🎯</span>
                        Guide Me
                    </button>
                    <button class="bug-action-btn analyze-log" onclick="analyzeLogAction('${escapeHtml(bug.id)}')">
                        <span>📊</span>
                        Analyze Log
                    </button>
                    <button class="bug-action-btn repro-scenario" onclick="reproScenarioAction('${escapeHtml(bug.id)}')">
                        <span>🔄</span>
                        Repro Scenario
                    </button>
                </div>
            `;
              messageDiv.innerHTML = `<div class="message-content"><div class="bug-info-display"><div class="bug-info-header"><div><div class="bug-title">${escapeHtml(bug.title)}</div><div class="bug-id">${escapeHtml(bug.id)}</div></div><div class="bug-status ${bug.status}">${escapeHtml(bug.status)}</div></div><div class="bug-meta"><div class="bug-meta-item"><div class="bug-meta-label">Priority</div><div class="bug-meta-value">${escapeHtml(bug.priority || 'N/A')}</div></div><div class="bug-meta-item"><div class="bug-meta-label">Category</div><div class="bug-meta-value">${escapeHtml(bug.category || 'N/A')}</div></div><div class="bug-meta-item"><div class="bug-meta-label">Assigned To</div><div class="bug-meta-value">${escapeHtml(bug.assignedTo || 'Unassigned')}</div></div><div class="bug-meta-item"><div class="bug-meta-label">Severity</div><div class="bug-meta-value">${escapeHtml(bug.severity || 'N/A')}</div></div><div class="bug-meta-item"><div class="bug-meta-label">Platform</div><div class="bug-meta-value">${escapeHtml(bug.platform || 'N/A')}</div></div><div class="bug-meta-item"><div class="bug-meta-label">Created</div><div class="bug-meta-value">${formatDate(bug.createdAt)}</div></div></div><div class="bug-description">${cleanDescription(bug.description)}</div>${tagsHtml}${actionButtonsHtml}</div></div><div class="message-time">${time}</div>`;
            
            chatContainer.appendChild(messageDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
            
            // Hide the bug lookup container after successful lookup
            document.getElementById('bugLookupContainer').classList.remove('show');
        }        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            try {
                const date = new Date(dateString);
                return date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            } catch (error) {
                return 'Invalid date';
            }
        }        function cleanDescription(description) {
            if (!description) return 'No description available.';
            
            // First escape any existing HTML to prevent XSS
            const escaped = escapeHtml(description);
            
            // Then apply our safe formatting
            return escaped
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>') // Convert bold markdown to HTML
                .replace(/\n\n+/g, '</p><p>') // Convert double line breaks to paragraphs
                .replace(/\n/g, '<br>') // Convert single line breaks to <br> tags
                .replace(/^/, '<p>') // Add opening paragraph tag
                .replace(/$/, '</p>') // Add closing paragraph tag
                .replace(/<p><\/p>/g, '') // Remove empty paragraphs
                .trim();
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            getStatus();
            document.getElementById('messageInput').focus();
        });

        function handleKeyPress(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        }

        async function sendMessage() {
            const input = document.getElementById('messageInput');
            const message = input.value.trim();
            
            if (!message || isProcessing) return;
            
            isProcessing = true;
            input.value = '';
            input.disabled = true;
            document.getElementById('sendButton').disabled = true;
            
            // Add user message to chat
            addMessage(message, 'user');
            
            // Show loading indicator
            document.getElementById('loadingIndicator').classList.add('show');
            
            try {
                const response = await fetch('/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ message: message })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    addMessage(data.response, 'assistant');
                } else {
                    addMessage('Sorry, I encountered an error. Please try again.', 'assistant');
                }
            } catch (error) {
                console.error('Error:', error);
                addMessage('Sorry, I couldn\'t connect to the server. Please check if it\'s running.', 'assistant');
            } finally {
                isProcessing = false;
                input.disabled = false;
                document.getElementById('sendButton').disabled = false;
                document.getElementById('loadingIndicator').classList.remove('show');
                input.focus();
            }
        }        function addMessage(text, sender, fileInfo = null) {
            const chatContainer = document.getElementById('chatContainer');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}`;
            
            const time = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            
            let messageContent = `
                <div class="message-content">${escapeHtml(text)}</div>
            `;
            
            if (fileInfo) {
                messageContent += `
                <div class="file-attachment">
                    <div class="file-icon">📄</div>
                    <div class="file-info">
                        <div class="file-name">${fileInfo.filename}</div>
                        <div class="file-size">${formatFileSize(fileInfo.size)}</div>
                    </div>
                    <button class="analyze-button" onclick="analyzeFile('${fileInfo.id}')" id="analyze-${fileInfo.id}">
                        Analyze
                    </button>
                </div>
                `;
            }
            
            messageContent += `<div class="message-time">${time}</div>`;
            
            messageDiv.innerHTML = messageContent;
            chatContainer.appendChild(messageDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }        function addAnalysisResult(analysis, findings) {
            const chatContainer = document.getElementById('chatContainer');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message assistant';
            
            const time = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            
            messageDiv.innerHTML = `
                <div class="message-content">
                    <div class="analysis-result">
                        <div class="analysis-header">
                            🔍 Log Analysis Results
                        </div>
                        <div class="analysis-content">${escapeHtml(analysis)}</div>
                    </div>
                </div>
                <div class="message-time">${time}</div>
            `;
            
            chatContainer.appendChild(messageDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function toggleFileUpload() {
            const uploadArea = document.getElementById('fileUploadArea');
            uploadArea.classList.toggle('show');
        }

        function handleDragOver(event) {
            event.preventDefault();
            event.currentTarget.classList.add('drag-over');
        }

        function handleDragLeave(event) {
            event.currentTarget.classList.remove('drag-over');
        }

        function handleDrop(event) {
            event.preventDefault();
            event.currentTarget.classList.remove('drag-over');
            
            const files = event.dataTransfer.files;
            if (files.length > 0) {
                handleFiles(files);
            }
        }

        function handleFileSelect(event) {
            const files = event.target.files;
            if (files.length > 0) {
                handleFiles(files);
            }
        }

        async function handleFiles(files) {
            for (let file of files) {
                await uploadFile(file);
            }
            
            // Hide upload area after successful upload
            document.getElementById('fileUploadArea').classList.remove('show');
        }

        async function uploadFile(file) {
            const formData = new FormData();
            formData.append('file', file);
            
            try {
                const response = await fetch('/upload', {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    uploadedFiles.push(data.file);
                    addMessage(`Uploaded file: ${file.name}`, 'user', data.file);
                } else {
                    addMessage(`Failed to upload ${file.name}: ${data.error}`, 'assistant');
                }
            } catch (error) {
                console.error('Error uploading file:', error);
                addMessage(`Error uploading ${file.name}`, 'assistant');
            }
        }

        async function analyzeFile(fileId) {
            const button = document.getElementById(`analyze-${fileId}`);
            button.disabled = true;
            button.textContent = 'Analyzing...';
            
            // Show loading indicator
            document.getElementById('loadingIndicator').classList.add('show');
            
            try {
                const response = await fetch(`/analyze/${fileId}`, {
                    method: 'POST'
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    addAnalysisResult(data.analysis, data.findings);
                    button.textContent = 'Analyzed';
                } else {
                    addMessage(`Error analyzing file: ${data.error}`, 'assistant');
                    button.disabled = false;
                    button.textContent = 'Analyze';
                }
            } catch (error) {
                console.error('Error analyzing file:', error);
                addMessage('Error analyzing file. Please try again.', 'assistant');
                button.disabled = false;
                button.textContent = 'Analyze';
            } finally {
                document.getElementById('loadingIndicator').classList.remove('show');
            }
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        async function clearChat() {
            if (confirm('Are you sure you want to clear the conversation?')) {
                try {
                    await fetch('/clear', { method: 'POST' });
                      // Clear chat display
                    const chatContainer = document.getElementById('chatContainer');
                    chatContainer.innerHTML = `
                        <div class="message assistant">
                            <div class="message-content">Conversation cleared. How can I help you today?</div>
                            <div class="message-time">Just now</div>
                        </div>
                    `;
                    
                    // Clear uploaded files
                    uploadedFiles = [];
                } catch (error) {
                    console.error('Error clearing chat:', error);
                }
            }
        }

        function toggleSettings() {
            const panel = document.getElementById('settingsPanel');
            panel.classList.toggle('open');
        }

        async function updateTemperature(value) {
            document.getElementById('temperatureValue').textContent = value;
            
            try {
                await fetch('/settings', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ temperature: parseFloat(value) })
                });
            } catch (error) {
                console.error('Error updating temperature:', error);
            }
        }

        async function updateMaxTokens(value) {
            document.getElementById('maxTokensValue').textContent = `${value} tokens`;
            
            try {
                await fetch('/settings', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ max_tokens: parseInt(value) })
                });
            } catch (error) {
                console.error('Error updating max tokens:', error);
            }
        }

        async function getStatus() {
            try {
                const response = await fetch('/status');
                const data = await response.json();
                
                document.getElementById('deviceInfo').textContent = `Device: ${data.device.toUpperCase()}`;
                document.getElementById('temperatureSlider').value = data.temperature;
                document.getElementById('temperatureValue').textContent = data.temperature;
                document.getElementById('maxTokensSlider').value = data.max_tokens;
                document.getElementById('maxTokensValue').textContent = `${data.max_tokens} tokens`;
            } catch (error) {
                console.error('Error getting status:', error);
            }
        }

        async function downloadHistory() {
            try {
                const response = await fetch('/history');
                const data = await response.json();
                
                let text = 'Phi-3 Chat History\n';
                text += '==================\n\n';
                
                data.history.forEach((turn, index) => {
                    text += `Turn ${index + 1}\n`;
                    text += `Time: ${new Date(turn.timestamp).toLocaleString()}\n`;
                    text += `User: ${turn.user}\n`;
                    text += `Assistant: ${turn.assistant}\n\n`;
                });
                
                // Create download
                const blob = new Blob([text], { type: 'text/plain' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `phi3-chat-${new Date().toISOString().split('T')[0]}.txt`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);
            } catch (error) {                console.error('Error downloading history:', error);
            }
        }

        // Bug Action Button Functions
        function guideMeAction(bugId) {
            console.log('Guide Me clicked for bug:', bugId);
            addMessage(`🎯 **Guide Me** initiated for bug ${bugId}`, 'assistant');
            
            if (currentBugData) {
                const guideMessage = `I'll help guide you through resolving **${currentBugData.title}**.

**Next Steps:**
1. **Review the bug details** - Check priority (${currentBugData.priority}) and category (${currentBugData.category})
2. **Understand the issue** - Analyze the description and reproduction steps
3. **Gather resources** - Collect logs, system info, and debugging tools
4. **Plan resolution** - Create an action plan based on the bug type

Would you like me to provide specific guidance for this **${currentBugData.category}** issue?`;
                addMessage(guideMessage, 'assistant');
            } else {
                addMessage('Please lookup a bug first to get specific guidance.', 'assistant');
            }
        }

        function analyzeLogAction(bugId) {
            console.log('Analyze Log clicked for bug:', bugId);
            addMessage(`📊 **Log Analysis** initiated for bug ${bugId}`, 'assistant');
            
            if (currentBugData) {
                const analysisMessage = `Ready to analyze logs for **${currentBugData.title}**.

**Analysis Focus Areas:**
• **Error patterns** related to ${currentBugData.category} issues
• **System state** at time of bug occurrence  
• **Resource usage** and performance metrics
• **Stack traces** and crash dumps

**To proceed:**
1. Upload relevant log files using the 📎 attachment button
2. I'll analyze them for patterns related to this **${currentBugData.priority}** priority ${currentBugData.category} bug
3. Provide insights and potential root causes

Click the attachment button above to upload your log files.`;
                addMessage(analysisMessage, 'assistant');
            } else {
                addMessage('Please lookup a bug first, then upload log files for targeted analysis.', 'assistant');
            }
        }

        function reproScenarioAction(bugId) {
            console.log('Repro Scenario clicked for bug:', bugId);
            addMessage(`🔄 **Reproduction Scenario** initiated for bug ${bugId}`, 'assistant');
            
            if (currentBugData) {
                const reproMessage = `Let's create a reproduction scenario for **${currentBugData.title}**.

**Reproduction Planning:**
• **Environment setup** for ${currentBugData.platform || 'target platform'}
• **Step-by-step recreation** of the issue
• **Expected vs actual behavior** documentation
• **Consistency testing** across different conditions

**Based on this ${currentBugData.category} bug:**
1. I'll help you design test scenarios
2. Create reproduction steps that isolate the issue
3. Identify variables that affect the bug occurrence
4. Document findings for the development team

Would you like me to create a detailed reproduction plan for this **${currentBugData.priority}** priority issue?`;
                addMessage(reproMessage, 'assistant');
            } else {
                addMessage('Please lookup a bug first to create a targeted reproduction scenario.', 'assistant');
            }
        }
    </script>
</body>
</html>
